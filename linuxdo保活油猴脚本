// ==UserScript==
// @name         linuxdoä¿æ´»
// @namespace    http://tampermonkey.net/
// @version      0.2.4
// @description  linuxdoè‡ªåŠ¨æµè§ˆå¸–å­ï¼Œè‡ªåŠ¨ç‚¹èµï¼ˆä¼˜åŒ–ç‰ˆï¼šé€‚é…linux.doï¼Œå¢å¼ºç¨³å®šæ€§ä¸å…¼å®¹æ€§ï¼›å¼€å…³å›¾æ ‡ç½®äºå³ä¸Šè§’ï¼Œæå‡æµç•…æ€§ï¼›ä¼˜åŒ–æµè§ˆé€Ÿåº¦æ¨¡æ‹Ÿäººå·¥é˜…è¯»ï¼›ä¿®å¤ç²¾ç®€ç‰ˆbugï¼‰
// @author       zhcf1ess (optimized by Grok)
// @match        https://linux.do/*
// @grant        GM_setValue
// @grant        GM_getValue
// @license      MIT
// @icon         https://linux.do/uploads/default/original/3X/9/d/9dd49731091ce8656e94433a26a3ef36062b3994.png
// @namespace    https://github.com/zhsama/linuxdo
// @supportURL   https://github.com/zhsama/linuxdo
// @homepageURL  https://github.com/zhsama/linuxdo
// @noframes
// @downloadURL  https://update.greasyfork.org/scripts/524017/linuxdo%E4%BF%9D%E6%B4%BB.user.js
// @updateURL    https://update.greasyfork.org/scripts/524017/linuxdo%E4%BF%9D%E6%B4%BB.meta.js
// ==/UserScript==

(function () {
    'use strict';

    // é…ç½®å¯¹è±¡ï¼ˆç²¾ç®€ï¼‰
    const config = {
        scrollInterval: 1000, // æ»šåŠ¨é—´éš”(æ¯«ç§’)ï¼Œç¼©çŸ­ä»¥åŠ é€Ÿ
        scrollStep: 600, // æ¯æ¬¡æ»šåŠ¨çš„åƒç´ ï¼Œè°ƒæ•´ä¸ºæ›´è‡ªç„¶
        viewCountThreshold: 500, // æµè§ˆé‡é˜ˆå€¼
        scrollDuration: 20, // æ»šåŠ¨æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œç¼©çŸ­æ¨¡æ‹Ÿå¿«é€Ÿé˜…è¯»
        maxTopics: 100, // æ€»æµè§ˆå¸–å­æ•°é‡
        maxRunTime: 30, // æ€»è¿è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
        minWaitTime: 1500, // å¸–å­é—´æœ€å°ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œç¼©çŸ­
        maxWaitTime: 5000, // å¸–å­é—´æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œç¼©çŸ­
        useIframe: true,
        urls: {
            base: 'https://linux.do',
            new: 'https://linux.do/new',
            connect: 'https://connect.linux.do'
        },
        iframe: {
            width: '325px',
            height: '500px',
            top: '64px',
            left: '1px',
            position: 'fixed',
            zIndex: '9999'
        },
        switchIcon: {
            top: '10px',
            right: '10px',
            size: '40px',
            background: '#6c757d',
            activeBackground: '#28a745'
        },
        logging: {
            enabled: true,
            level: { error: true, info: true, debug: false }
        },
        statsPanel: { enabled: true }
    };

    // æ—¥å¿—å·¥å…·ï¼ˆç²¾ç®€ï¼‰
    const log = (level, ...args) => config.logging.enabled && config.logging.level[level] && console[level](...args);

    // ç»Ÿè®¡å¯¹è±¡ï¼ˆç²¾ç®€ï¼‰
    const stats = { totalViews: 0, totalLikes: 0, sessionViews: 0, sessionLikes: 0, startTime: Date.now() };

    // åŠ è½½/ä¿å­˜ç»Ÿè®¡ï¼ˆåˆå¹¶ï¼‰
    const loadSaveStats = (load = true) => {
        const key = 'linuxdoStats';
        if (load) {
            const saved = GM_getValue(key, {});
            stats.totalViews = saved.totalViews || 0;
            stats.totalLikes = saved.totalLikes || 0;
            log('info', 'ğŸ“Š åŠ è½½ç»Ÿè®¡ï¼š', stats.totalViews, 'æµè§ˆï¼Œ', stats.totalLikes, 'ç‚¹èµ');
        } else {
            GM_setValue(key, { totalViews: stats.totalViews, totalLikes: stats.totalLikes });
        }
    };

    // æ›´æ–°ç»Ÿè®¡
    const updateStats = (type) => {
        if (type === 'view') { stats.sessionViews++; stats.totalViews++; }
        else if (type === 'like') { stats.sessionLikes++; stats.totalLikes++; }
        loadSaveStats(false);
        updateStatsPanel();
    };

    // æ‰“å°ç»Ÿè®¡
    const printStats = () => {
        const runTime = Math.floor((Date.now() - stats.startTime) / 1000);
        const timeStr = `${Math.floor(runTime / 60)}åˆ†${runTime % 60}ç§’`;
        log('info', '\nğŸ“Š ç»Ÿè®¡ï¼š', timeStr, '| æœ¬æ¬¡æµè§ˆ:', stats.sessionViews, '| æœ¬æ¬¡ç‚¹èµ:', stats.sessionLikes, '| æ€»æµè§ˆ:', stats.totalViews, '| æ€»ç‚¹èµ:', stats.totalLikes, '\n');
    };

    // ç»Ÿè®¡é¢æ¿ï¼ˆç²¾ç®€ï¼‰
    let statsPanel = null;
    const updateStatsPanel = () => {
        if (!config.statsPanel.enabled || !statsPanel) return;
        const runTime = Math.floor((Date.now() - stats.startTime) / 1000);
        const timeStr = `${Math.floor(runTime / 60)}åˆ†${runTime % 60}ç§’`;
        statsPanel.innerHTML = `<strong>ğŸ“Š ç»Ÿè®¡</strong><br>ğŸ•’ ${timeStr}<br>ğŸ‘€ æœ¬æ¬¡æµè§ˆï¼š${stats.sessionViews}<br>â¤ï¸ æœ¬æ¬¡ç‚¹èµï¼š${stats.sessionLikes}<br>ğŸ“ˆ æ€»æµè§ˆï¼š${stats.totalViews}<br>ğŸ’– æ€»ç‚¹èµï¼š${stats.totalLikes}<br><span style="color:red;" id="error-msg"></span>`;
    };
    const createStatsPanel = () => {
        if (!config.statsPanel.enabled || statsPanel) return;
        statsPanel = document.createElement('div');
        statsPanel.style.cssText = 'position:fixed;top:120px;left:10px;z-index:9998;background:#fff;border:1px solid #ccc;padding:10px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,0.2);font-size:12px;width:200px;';
        document.body.appendChild(statsPanel);
        updateStatsPanel();
    };
    const setErrorMsg = (msg) => {
        if (!statsPanel) return;
        let errorSpan = statsPanel.querySelector('#error-msg');
        if (!errorSpan) {
            errorSpan = document.createElement('span');
            errorSpan.id = 'error-msg';
            errorSpan.style.color = 'red';
            statsPanel.appendChild(errorSpan);
        }
        errorSpan.textContent = msg;
    };

    // å¼€å…³çŠ¶æ€
    const getSwitchState = () => GM_getValue('linuxdoHelperEnabled', false);
    const toggleSwitch = () => {
        const state = !getSwitchState();
        GM_setValue('linuxdoHelperEnabled', state);
        if (state) window.location.href = config.urls.base;
        else if (statsPanel) { document.body.removeChild(statsPanel); statsPanel = null; }
        log('info', `LinuxdoåŠ©æ‰‹å·²${state ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
        updateSwitchIcon();
    };

    // å¼€å…³å›¾æ ‡ï¼ˆç²¾ç®€ï¼Œå›ºå®šå³ä¸Šè§’ï¼‰
    let switchIcon = null;
    const createSwitchIcon = () => {
        if (switchIcon) return;
        const container = document.createElement('div');
        container.id = 'linuxdo-switch-container';
        container.style.cssText = `position:fixed;top:${config.switchIcon.top};right:${config.switchIcon.right};z-index:10000;pointer-events:none;`;
        document.body.appendChild(container);

        switchIcon = document.createElement('button');
        switchIcon.id = 'linuxdo-switch-icon';
        switchIcon.style.cssText = `width:${config.switchIcon.size};height:${config.switchIcon.size};border:none;border-radius:50%;cursor:pointer;pointer-events:all;background-color:${config.switchIcon.background};color:white;box-shadow:0 2px 5px rgba(0,0,0,0.2);transition:background-color 0.3s ease;`;
        switchIcon.title = getSwitchState() ? 'åœæ­¢LinuxdoåŠ©æ‰‹' : 'å¯åŠ¨LinuxdoåŠ©æ‰‹';
        switchIcon.tabIndex = 0;

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('width', '24');
        svg.setAttribute('height', '24');
        svg.style.cssText = 'fill:currentColor;';

        const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
        use.setAttribute('href', getSwitchState() ? '#pause' : '#play');
        svg.appendChild(use);
        switchIcon.appendChild(svg);
        container.appendChild(switchIcon);

        switchIcon.addEventListener('click', toggleSwitch);
        updateSwitchIcon();
        log('info', 'å¼€å…³å›¾æ ‡åˆ›å»ºäºå³ä¸Šè§’');
    };
    const updateSwitchIcon = () => {
        if (!switchIcon) return;
        const state = getSwitchState();
        const use = switchIcon.querySelector('use');
        if (use) use.setAttribute('href', state ? '#pause' : '#play');
        switchIcon.title = state ? 'åœæ­¢LinuxdoåŠ©æ‰‹' : 'å¯åŠ¨LinuxdoåŠ©æ‰‹';
        switchIcon.style.backgroundColor = state ? config.switchIcon.activeBackground : config.switchIcon.background;
    };

    // CAPTCHAæ£€æŸ¥ï¼ˆç²¾ç®€é€‰æ‹©å™¨ï¼‰
    const checkForCaptcha = (targetWindow) => {
        const captcha = targetWindow.document.querySelector('[id*="captcha"],[class*="captcha"],[data-captcha],iframe[src*="captcha"]');
        if (captcha) {
            log('error', 'æ£€æµ‹åˆ° CAPTCHAï¼Œæš‚åœï¼');
            setErrorMsg('æ£€æµ‹åˆ° CAPTCHAï¼Œè¯·æ‰‹åŠ¨å¤„ç†');
            return true;
        }
        return false;
    };

    // ç‚¹èµï¼ˆç²¾ç®€ï¼Œå¢å¼ºå…¼å®¹ï¼‰
    const checkAndLike = async (targetWindow = window) => {
        try {
            if (checkForCaptcha(targetWindow)) return false;
            const viewsElement = targetWindow.document.querySelector('.num.views .number, [data-view-count], [class*="views"] .number, .topic-views');
            if (!viewsElement) return log('info', 'æœªæ‰¾åˆ°æµè§ˆé‡ï¼Œè·³è¿‡ç‚¹èµ'), false;
            let viewCount = parseInt((viewsElement.getAttribute('title') || viewsElement.textContent || viewsElement.innerText || '').replace(/[^0-9]/g, '')) || 0;
            if (viewCount <= config.viewCountThreshold) return false;

            const likeButton = targetWindow.document.querySelector('button.toggle-like, button.btn-toggle-reaction-like, button[aria-label*="like"], button[data-action="like"], .reaction-like');
            if (!likeButton) return log('info', 'æœªæ‰¾åˆ°ç‚¹èµæŒ‰é’®'), false;

            const isLiked = likeButton.getAttribute('aria-pressed') === 'true' || likeButton.classList.contains('active') || likeButton.title?.includes('åˆ é™¤æ­¤ heart å›åº”') || likeButton.innerHTML.includes('heart');
            if (isLiked) return log('info', 'å·²ç‚¹èµï¼Œè·³è¿‡'), false;

            likeButton.focus();
            likeButton.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
            await new Promise(r => setTimeout(r, 300));
            log('info', 'ç‚¹èµæˆåŠŸ');
            updateStats('like');
            return true;
        } catch (e) {
            log('error', 'ç‚¹èµå¤±è´¥:', e);
            setErrorMsg('ç‚¹èµå¤±è´¥');
            return false;
        }
    };

    // è·å–å¸–å­åˆ—è¡¨ï¼ˆç²¾ç®€ï¼Œä½¿ç”¨requestAnimationFrameï¼‰
    const getTopicsList = async () => {
        return new Promise(resolve => {
            let attempts = 0, maxAttempts = 10;
            const check = () => {
                const topics = document.querySelectorAll('.topic-list .link-top-line a.title, #list-area .title, .topic-title a');
                if (topics.length > 0) {
                    const list = [];
                    log('info', `æ‰¾åˆ° ${topics.length} å¸–å­`);
                    topics.forEach(topic => {
                        const parent = topic.closest('tr, .topic-row, .topic-list-item');
                        if (!parent) return;
                        if (parent.querySelector('.topic-statuses .pinned, [class*="pinned"]')) return log('debug', `è·³è¿‡ç½®é¡¶ï¼š${topic.textContent.trim()}`);
                        const viewsEl = parent.querySelector('.num.views .number, [class*="views"]');
                        const views = parseInt((viewsEl?.getAttribute('title') || viewsEl?.textContent || '').replace(/[^0-9]/g, '')) || 0;
                        list.push({ title: topic.textContent.trim(), url: topic.href, views });
                    });
                    resolve(list);
                    return;
                }
                if (++attempts < maxAttempts) requestAnimationFrame(check);
                else resolve([]), log('info', 'å¸–å­åŠ è½½è¶…æ—¶');
            };
            check();
        });
    };

    // æµè§ˆå¸–å­ï¼ˆä¿®å¤æ»šåŠ¨bugï¼šä½¿ç”¨setIntervalæ¨¡æ‹Ÿäººå·¥ï¼Œç§»é™¤æ— æ•ˆawaitï¼‰
    const browseTopic = async (topic) => {
        log('info', `æµè§ˆï¼š${topic.title}`);
        updateStats('view');

        if (config.useIframe) {
            const iframe = document.createElement('iframe');
            Object.assign(iframe.style, config.iframe);
            iframe.sandbox = 'allow-scripts allow-same-origin';
            iframe.src = `${topic.url}?_t=${Date.now()}`;
            document.body.appendChild(iframe);

            await new Promise(resolve => {
                const timeout = setTimeout(() => { if (iframe.parentNode) iframe.parentNode.removeChild(iframe); resolve(); }, 8000);
                iframe.onload = () => {
                    clearTimeout(timeout);
                    const win = iframe.contentWindow;
                    if (win && !checkForCaptcha(win)) checkAndLike(win);
                    resolve();
                };
            });

            // æ¨¡æ‹Ÿäººå·¥æ»šåŠ¨ï¼šä½¿ç”¨setIntervalï¼Œéšæœºæ­¥é•¿/æ–¹å‘ï¼Œéšæœºæš‚åœ
            await new Promise(resolve => {
                const start = Date.now();
                let intervalId;
                let pauseTimeout = null;
                const scroll = () => {
                    const elapsed = Date.now() - start;
                    if (elapsed >= config.scrollDuration * 1000) {
                        clearInterval(intervalId);
                        if (pauseTimeout) clearTimeout(pauseTimeout);
                        if (iframe.parentNode) iframe.parentNode.removeChild(iframe);
                        printStats();
                        resolve();
                        return;
                    }
                    try {
                        const win = iframe.contentWindow;
                        if (win) {
                            // éšæœºæ­¥é•¿å’Œæ–¹å‘æ¨¡æ‹Ÿè‡ªç„¶
                            const step = (Math.random() > 0.7 ? -config.scrollStep / 2 : config.scrollStep) * (0.8 + Math.random() * 0.4);
                            win.scrollBy(0, step);
                            // éšæœºæš‚åœæ¨¡æ‹Ÿé˜…è¯»ï¼ˆä½¿ç”¨setTimeoutï¼‰
                            if (Math.random() > 0.8) {
                                pauseTimeout = setTimeout(() => {}, 500 + Math.random() * 1000);
                            }
                        }
                    } catch (e) { log('debug', 'æ»šåŠ¨å¤±è´¥:', e); }
                };
                intervalId = setInterval(scroll, config.scrollInterval);
            });

            await new Promise(r => setTimeout(r, 800));
        } else {
            const origUrl = window.location.href;
            window.location.href = topic.url;
            await new Promise(r => setTimeout(r, config.scrollDuration * 1000 + 1500));
            await checkAndLike(window);
            window.location.href = origUrl;
            await new Promise(r => setTimeout(r, 1500));
        }
    };

    // æ£€æŸ¥åœæ­¢
    const shouldStopScript = () => {
        if (stats.sessionViews >= config.maxTopics) return log('info', `ğŸ›‘ è¾¾åˆ° ${config.maxTopics} å¸–ï¼Œåœæ­¢`), true;
        const runTime = (Date.now() - stats.startTime) / 1000 / 60;
        if (runTime >= config.maxRunTime) return log('info', `ğŸ›‘ è¾¾åˆ° ${config.maxRunTime} åˆ†ï¼Œåœæ­¢`), true;
        return false;
    };

    // åœæ­¢è„šæœ¬
    const stopScript = () => {
        GM_setValue('linuxdoHelperEnabled', false);
        printStats();
        log('info', 'âœ¨ è„šæœ¬åœæ­¢');
        if (statsPanel) { document.body.removeChild(statsPanel); statsPanel = null; }
        updateSwitchIcon();
        window.location.href = config.urls.connect;
    };

    // ä¸»è¦æµè§ˆ
    const browseTopics = async () => {
        try {
            const topics = await getTopicsList();
            if (topics.length === 0) return log('info', 'æ— å¸–å­'), setErrorMsg('æœªæ‰¾åˆ°å¸–å­');
            const shuffled = topics.sort(() => Math.random() - 0.5);
            for (const topic of shuffled) {
                if (shouldStopScript()) return stopScript();
                if (!getSwitchState()) return log('info', 'æ‰‹åŠ¨åœæ­¢');
                await browseTopic(topic);
                const wait = config.minWaitTime + Math.random() * (config.maxWaitTime - config.minWaitTime);
                await new Promise(r => setTimeout(r, wait));
            }
        } catch (e) {
            log('error', 'æµè§ˆå‡ºé”™:', e);
            setErrorMsg('æµè§ˆå‡ºé”™');
        }
    };

    // ä¸»å‡½æ•°
    const main = async () => {
        log('info', 'âš ï¸ ä½¿ç”¨å¯èƒ½è¿åæœåŠ¡æ¡æ¬¾ï¼Œè¯·è°¨æ…ï¼');
        createSwitchIcon();
        if (!getSwitchState()) return;

        loadSaveStats(true);
        createStatsPanel();
        updateStatsPanel(); // ç¡®ä¿åˆå§‹æ›´æ–°

        if (window.location.href.includes(config.urls.base) || window.location.href.includes(config.urls.new)) {
            if (shouldStopScript()) stopScript();
            else await browseTopics();
        }
    };

    // æ‰§è¡Œï¼ˆç²¾ç®€ç›‘å¬ï¼‰
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', main);
    else setTimeout(main, 100); // è½»å¾®å»¶è¿Ÿç¡®ä¿DOMå°±ç»ª

    // å˜åŒ–ç›‘å¬ï¼ˆç²¾ç®€ï¼‰
    new MutationObserver(() => { if (getSwitchState() && !switchIcon) createSwitchIcon(); }).observe(document.body, { childList: true, subtree: true });
})();
